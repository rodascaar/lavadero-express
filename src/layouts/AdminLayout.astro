---
import { verifySession, getSessionCookie } from "../lib/auth";
import prisma from "../lib/prisma";

export interface Props {
    title: string;
}

const { title } = Astro.props;

// Check authentication
const sessionCookie = Astro.cookies.get(getSessionCookie());
const session = sessionCookie ? verifySession(sessionCookie.value) : null;

if (!session) {
    return Astro.redirect("/admin/login");
}

// Get current user
const user = await prisma.user.findUnique({
    where: { email: session.email },
    select: { name: true, email: true },
});

const currentPath = Astro.url.pathname;

const navItems = [
    { href: "/admin", icon: "ğŸ“Š", label: "Dashboard" },
    { href: "/admin/bookings", icon: "ğŸ“…", label: "Reservas" },
    { href: "/admin/contacts", icon: "ğŸ‘¥", label: "Clientes" },
    { href: "/admin/services", icon: "ğŸš—", label: "Servicios" },
    { href: "/admin/settings", icon: "âš™ï¸", label: "ConfiguraciÃ³n" },
];
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <title>{title} - Admin</title>
    </head>
    <body class="bg-slate-100">
        <!-- Mobile menu button -->
        <button id="mobile-menu-btn" class="mobile-menu-btn">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Overlay for mobile -->
        <div id="sidebar-overlay" class="sidebar-overlay"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div
                class="p-6 border-b border-slate-800 flex items-center justify-between"
            >
                <div>
                    <h1 class="text-xl font-bold">ğŸš— AutoSpa</h1>
                    <p class="text-slate-400 text-sm mt-1">
                        Panel de AdministraciÃ³n
                    </p>
                </div>
                <button
                    id="close-sidebar"
                    class="lg:hidden p-2 text-slate-400 hover:text-white"
                >
                    âœ•
                </button>
            </div>

            <nav class="flex-1 py-4 overflow-y-auto">
                {
                    navItems.map((item) => (
                        <a
                            href={item.href}
                            class={
                                currentPath === item.href
                                    ? "sidebar-link-active"
                                    : "sidebar-link"
                            }
                        >
                            <span class="text-xl">{item.icon}</span>
                            <span>{item.label}</span>
                        </a>
                    ))
                }
            </nav>

            <div class="p-4 border-t border-slate-800">
                <a
                    href="/"
                    target="_blank"
                    class="btn bg-slate-800 text-slate-300 hover:bg-slate-700 hover:text-white w-full text-sm mb-3"
                >
                    ğŸŒ Ver Sitio Web
                </a>
                <div class="flex items-center gap-3 mb-3">
                    <div
                        class="w-10 h-10 rounded-full bg-primary-600 flex items-center justify-center text-white font-bold flex-shrink-0"
                    >
                        {user?.name?.charAt(0) || "A"}
                    </div>
                    <div class="min-w-0">
                        <p class="font-medium text-sm truncate">{user?.name}</p>
                        <p class="text-slate-400 text-xs truncate">
                            {user?.email}
                        </p>
                    </div>
                </div>
                <a
                    href="/admin/logout"
                    class="btn btn-secondary w-full text-sm"
                >
                    Cerrar SesiÃ³n
                </a>
            </div>
        </aside>

        <!-- Main content -->
        <main class="lg:ml-64 min-h-screen pt-16 lg:pt-0">
            <header
                class="bg-white border-b border-slate-200 px-4 sm:px-8 py-4"
            >
                <h2 class="text-xl sm:text-2xl font-bold text-slate-900">
                    {title}
                </h2>
            </header>
            <div class="p-4 sm:p-8">
                <slot />
            </div>
        </main>

        <script>
            const sidebar = document.getElementById("sidebar");
            const overlay = document.getElementById("sidebar-overlay");
            const menuBtn = document.getElementById("mobile-menu-btn");
            const closeBtn = document.getElementById("close-sidebar");

            function openSidebar() {
                sidebar?.classList.add("open");
                overlay?.classList.add("open");
                document.body.style.overflow = "hidden";
            }

            function closeSidebar() {
                sidebar?.classList.remove("open");
                overlay?.classList.remove("open");
                document.body.style.overflow = "";
            }

            menuBtn?.addEventListener("click", openSidebar);
            closeBtn?.addEventListener("click", closeSidebar);
            overlay?.addEventListener("click", closeSidebar);

            // Close on escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeSidebar();
            });

            // Close sidebar when clicking a link on mobile
            sidebar?.querySelectorAll("a").forEach((link) => {
                link.addEventListener("click", () => {
                    if (window.innerWidth < 1024) {
                        closeSidebar();
                    }
                });
            });
        </script>
    </body>
</html>

<style is:global>
    @import "../styles/global.css";
</style>
