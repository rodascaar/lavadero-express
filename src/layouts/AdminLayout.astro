---
import { verifySession, getSessionCookie } from "../lib/auth";
import prisma from "../lib/prisma";

export interface Props {
    title: string;
}

const { title } = Astro.props;

// Check authentication (Middleware should handle this, but double check)
const session = Astro.locals.user;

if (!session) {
    return Astro.redirect("/admin/login");
}

// Get current user
const user = await prisma.user.findUnique({
    where: { email: session.email },
    select: { name: true, email: true },
});

const currentPath = Astro.url.pathname;

const navItems = [
    { href: "/admin", icon: "üìä", label: "Dashboard" },
    { href: "/admin/bookings", icon: "üìÖ", label: "Reservas" },
    { href: "/admin/contacts", icon: "üë•", label: "Clientes" },
    { href: "/admin/services", icon: "üöó", label: "Servicios" },
    { href: "/admin/settings", icon: "‚öôÔ∏è", label: "Configuraci√≥n" },
];
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <title>{title} - Admin</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Montserrat:wght@300;400;500;600&display=swap"
            rel="stylesheet"
        />
    </head>
    <body
        class="bg-luxury-black text-white font-sans antialiased selection:bg-primary-500/30 selection:text-white"
    >
        <!-- Mobile menu button -->
        <button
            id="mobile-menu-btn"
            class="mobile-menu-btn text-white hover:text-primary-500 transition-colors"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Overlay for mobile -->
        <div
            id="sidebar-overlay"
            class="sidebar-overlay bg-black/80 backdrop-blur-sm"
        >
        </div>

        <!-- Sidebar -->
        <aside
            id="sidebar"
            class="sidebar bg-[#080808] border-r border-white/5 shadow-2xl transition-all duration-300"
        >
            <div
                class="p-6 border-b border-white/10 flex items-center justify-between"
            >
                <div>
                    <h1
                        class="text-xl font-bold font-heading text-white tracking-wide"
                    >
                        <span class="text-primary-500">Auto</span>Spa
                    </h1>
                    <p
                        class="text-gray-400 text-xs mt-1 font-technical uppercase tracking-widest"
                    >
                        Panel de Control
                    </p>
                </div>
                <button
                    id="close-sidebar"
                    class="lg:hidden p-2 text-gray-400 hover:text-white transition-colors"
                >
                    ‚úï
                </button>
            </div>

            <nav class="flex-1 py-6 overflow-y-auto px-3 space-y-1">
                {
                    navItems.map((item) => {
                        const isActive =
                            currentPath === item.href ||
                            (item.href !== "/admin" &&
                                currentPath.startsWith(item.href));
                        return (
                            <a
                                href={item.href}
                                class={`
                                    flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 font-medium
                                    ${
                                        isActive
                                            ? "bg-primary-500/10 text-primary-400 border-l-4 border-primary-500"
                                            : "text-gray-400 hover:text-white hover:bg-white/5 border-l-4 border-transparent"
                                    }
                                `}
                            >
                                <span
                                    class={`text-xl ${isActive ? "scale-110" : ""}`}
                                >
                                    {item.icon}
                                </span>
                                <span class="tracking-wide">{item.label}</span>
                            </a>
                        );
                    })
                }
            </nav>

            <div class="p-4 border-t border-white/5 bg-black/40">
                <a
                    href="/"
                    target="_blank"
                    class="flex items-center justify-center gap-2 w-full py-2.5 px-4 rounded-lg bg-white/5 text-gray-300 hover:text-white hover:bg-white/10 transition-all text-sm mb-4 font-technical uppercase tracking-wider border border-white/10"
                >
                    <span>‚Üó</span> Ver Sitio Web
                </a>
                <div
                    class="flex items-center gap-3 mb-4 p-3 rounded-lg bg-white/5 border border-white/10"
                >
                    <div
                        class="w-10 h-10 rounded-full bg-gradient-to-br from-primary-600 to-primary-800 flex items-center justify-center text-white font-bold flex-shrink-0 shadow-lg shadow-primary-900/50"
                    >
                        {user?.name?.charAt(0) || "A"}
                    </div>
                    <div class="min-w-0">
                        <p class="font-medium text-sm text-white truncate">
                            {user?.name}
                        </p>
                        <p
                            class="text-gray-400 text-xs truncate font-technical"
                        >
                            {user?.email}
                        </p>
                    </div>
                </div>
                <a
                    href="/admin/logout"
                    class="block text-center w-full py-2 text-xs font-technical uppercase tracking-widest text-red-500 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors"
                >
                    Cerrar Sesi√≥n
                </a>
            </div>
        </aside>

        <!-- Main content -->
        <main class="lg:ml-64 min-h-screen pt-16 lg:pt-0 bg-luxury-black">
            <header
                class="bg-luxury-black/80 backdrop-blur-md border-b border-white/10 px-4 sm:px-8 py-6 sticky top-0 z-30"
            >
                <h2
                    class="text-2xl sm:text-3xl font-bold font-heading text-white"
                >
                    {title}
                </h2>
            </header>
            <div class="p-4 sm:p-8">
                <slot />
            </div>
        </main>

        <script>
            const sidebar = document.getElementById("sidebar");
            const overlay = document.getElementById("sidebar-overlay");
            const menuBtn = document.getElementById("mobile-menu-btn");
            const closeBtn = document.getElementById("close-sidebar");

            function openSidebar() {
                sidebar?.classList.add("open");
                overlay?.classList.add("open");
                document.body.style.overflow = "hidden";
            }

            function closeSidebar() {
                sidebar?.classList.remove("open");
                overlay?.classList.remove("open");
                document.body.style.overflow = "";
            }

            menuBtn?.addEventListener("click", openSidebar);
            closeBtn?.addEventListener("click", closeSidebar);
            overlay?.addEventListener("click", closeSidebar);

            // Close on escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeSidebar();
            });

            // Close sidebar when clicking a link on mobile
            sidebar?.querySelectorAll("a").forEach((link) => {
                link.addEventListener("click", () => {
                    if (window.innerWidth < 1024) {
                        closeSidebar();
                    }
                });
            });
        </script>
    </body>
</html>

<style is:global>
    @import "../styles/global.css";
</style>
