---
import AdminLayout from "../../layouts/AdminLayout.astro";
import CreateUserForm from "../../components/CreateUserForm";
import prisma from "../../lib/prisma";
import { isAdmin } from "../../lib/auth";

const session = Astro.locals.user;

if (!isAdmin(session)) {
    return Astro.redirect("/admin");
}

const users = await prisma.user.findMany({
    orderBy: { createdAt: "desc" },
    select: {
        id: true,
        name: true,
        email: true,
        role: true,
        failedLoginAttempts: true,
        lockedUntil: true,
    },
});

const statusLabels: Record<string, string> = {
    ADMIN: "Administrador",
    EMPLOYEE: "Operador",
};
---

<AdminLayout title="Gestión de Usuarios">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- User List -->
        <div class="lg:col-span-2">
            <div
                class="bg-luxury-card border border-white/5 rounded-2xl overflow-hidden"
            >
                <div
                    class="p-6 border-b border-white/10 flex justify-between items-center"
                >
                    <h3 class="font-heading text-xl text-white">
                        Personal Registrado
                    </h3>
                    <span
                        class="text-xs font-technical uppercase tracking-widest text-primary-500"
                        >{users.length} Usuarios</span
                    >
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr
                                class="bg-black/20 text-[10px] font-technical uppercase tracking-widest text-gray-500"
                            >
                                <th class="px-6 py-4">Usuario</th>
                                <th class="px-6 py-4">Rol</th>
                                <th class="px-6 py-4">Estado</th>
                                <th class="px-6 py-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            {
                                users.map((user) => (
                                    <tr class="hover:bg-white/[0.02] transition-colors group">
                                        <td class="px-6 py-5">
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-primary-500 font-bold group-hover:border-primary-500/50 transition-colors">
                                                    {user.name.charAt(0)}
                                                </div>
                                                <div>
                                                    <div class="text-sm font-medium text-white">
                                                        {user.name}
                                                    </div>
                                                    <div class="text-xs text-gray-500 font-technical">
                                                        {user.email}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-5">
                                            <span
                                                class={`px-2 py-1 rounded text-[10px] font-technical uppercase tracking-widest border ${
                                                    user.role === "ADMIN"
                                                        ? "bg-primary-500/10 text-primary-400 border-primary-500/20"
                                                        : "bg-blue-500/10 text-blue-400 border-blue-500/20"
                                                }`}
                                            >
                                                {statusLabels[user.role]}
                                            </span>
                                        </td>
                                        <td class="px-6 py-5">
                                            {user.lockedUntil &&
                                            new Date(user.lockedUntil) >
                                                new Date() ? (
                                                <div class="flex items-center gap-2 text-red-500">
                                                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse" />
                                                    <span class="text-[10px] font-technical uppercase tracking-widest font-bold">
                                                        Bloqueado
                                                    </span>
                                                </div>
                                            ) : (
                                                <div class="flex items-center gap-2 text-emerald-500">
                                                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500" />
                                                    <span class="text-[10px] font-technical uppercase tracking-widest">
                                                        Activo
                                                    </span>
                                                </div>
                                            )}
                                            {user.failedLoginAttempts > 0 &&
                                                !(
                                                    user.lockedUntil &&
                                                    new Date(user.lockedUntil) >
                                                        new Date()
                                                ) && (
                                                    <div class="text-[9px] text-amber-500/70 font-technical mt-1 uppercase">
                                                        {
                                                            user.failedLoginAttempts
                                                        }{" "}
                                                        intentos fallidos
                                                    </div>
                                                )}
                                        </td>
                                        <td class="px-6 py-5 text-right">
                                            {user.lockedUntil &&
                                                new Date(user.lockedUntil) >
                                                    new Date() && (
                                                    <button
                                                        data-email={user.email}
                                                        class="unlock-btn text-[10px] font-technical uppercase tracking-widest text-primary-500 hover:text-primary-400 transition-colors"
                                                    >
                                                        Desbloquear
                                                    </button>
                                                )}
                                        </td>
                                    </tr>
                                ))
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add User Form -->
        <div class="lg:col-span-1">
            <CreateUserForm client:load />
        </div>
    </div>

    <script>
        // Handle account unlocking
        document.querySelectorAll(".unlock-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                const email = (e.target as HTMLButtonElement).dataset.email;
                const newPassword = prompt(
                    `Ingresa la nueva contraseña para ${email}:`,
                );

                if (!newPassword) return;

                try {
                    const res = await fetch("/api/admin/users", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            action: "unlock",
                            targetEmail: email,
                            newPassword,
                        }),
                    });

                    if (res.ok) {
                        alert("Usuario desbloqueado exitosamente");
                        window.location.reload();
                    } else {
                        const data = await res.json();
                        alert("Error: " + data.error);
                    }
                } catch (err) {
                    alert("Error de conexión");
                }
            });
        });
    </script>
</AdminLayout>
