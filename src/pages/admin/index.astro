---
import AdminLayout from "../../layouts/AdminLayout.astro";
import prisma from "../../lib/prisma";

// Get today's date range
const today = new Date();
today.setHours(0, 0, 0, 0);
const tomorrow = new Date(today);
tomorrow.setDate(tomorrow.getDate() + 1);

// Get week range for chart
const weekAgo = new Date(today);
weekAgo.setDate(weekAgo.getDate() - 7);

// Fetch KPIs
const [todayBookings, pendingCount, weekBookings, recentBookings] =
    await Promise.all([
        prisma.booking.findMany({
            where: {
                date: { gte: today, lt: tomorrow },
            },
            include: { service: true },
        }),
        prisma.booking.count({
            where: { status: "PENDING" },
        }),
        prisma.booking.findMany({
            where: {
                date: { gte: weekAgo },
                status: { not: "CANCELLED" },
            },
            include: { service: true },
        }),
        prisma.booking.findMany({
            take: 5,
            orderBy: { createdAt: "desc" },
            include: {
                customer: true,
                service: true,
            },
        }),
    ]);

// Calculate KPIs
const todayRevenue = todayBookings
    .filter((b) => b.status !== "CANCELLED")
    .reduce((sum, b) => sum + Number(b.totalPrice), 0);

// Group bookings by day for chart
const dailyRevenue: Record<string, number> = {};
for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split("T")[0];
    dailyRevenue[dateStr] = 0;
}

weekBookings.forEach((booking) => {
    const dateStr = new Date(booking.date).toISOString().split("T")[0];
    if (dailyRevenue[dateStr] !== undefined) {
        dailyRevenue[dateStr] += Number(booking.totalPrice);
    }
});

const chartData = Object.entries(dailyRevenue).map(([date, amount]) => ({
    date: new Date(date).toLocaleDateString("es-ES", {
        weekday: "short",
        day: "numeric",
    }),
    amount,
}));

const statusColors: Record<string, string> = {
    PENDING: "badge-pending",
    CONFIRMED: "badge-confirmed",
    IN_PROGRESS: "badge-in-progress",
    COMPLETED: "badge-completed",
    CANCELLED: "badge-cancelled",
};

const statusLabels: Record<string, string> = {
    PENDING: "Pendiente",
    CONFIRMED: "Confirmado",
    IN_PROGRESS: "En Proceso",
    COMPLETED: "Finalizado",
    CANCELLED: "Cancelado",
};
---

<AdminLayout title="Dashboard">
    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="kpi-card">
            <div class="flex items-center gap-3 mb-4">
                <div
                    class="w-12 h-12 rounded-xl bg-primary-100 flex items-center justify-center text-2xl"
                >
                    üìÖ
                </div>
                <div>
                    <div class="kpi-value">{todayBookings.length}</div>
                    <div class="kpi-label">Reservas Hoy</div>
                </div>
            </div>
        </div>

        <div class="kpi-card">
            <div class="flex items-center gap-3 mb-4">
                <div
                    class="w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center text-2xl"
                >
                    üí∞
                </div>
                <div>
                    <div class="kpi-value">
                        {new Intl.NumberFormat("es-PY").format(todayRevenue)} ‚Ç≤
                    </div>
                    <div class="kpi-label">Ingresos Hoy</div>
                </div>
            </div>
        </div>

        <div class="kpi-card">
            <div class="flex items-center gap-3 mb-4">
                <div
                    class="w-12 h-12 rounded-xl bg-amber-100 flex items-center justify-center text-2xl"
                >
                    ‚è≥
                </div>
                <div>
                    <div class="kpi-value">{pendingCount}</div>
                    <div class="kpi-label">Pendientes</div>
                </div>
            </div>
        </div>

        <div class="kpi-card">
            <div class="flex items-center gap-3 mb-4">
                <div
                    class="w-12 h-12 rounded-xl bg-teal-100 flex items-center justify-center text-2xl"
                >
                    ‚úÖ
                </div>
                <div>
                    <div class="kpi-value">{weekBookings.length}</div>
                    <div class="kpi-label">Completados (7 d√≠as)</div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Chart -->
        <div class="lg:col-span-2 card p-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">
                Ingresos - √öltimos 7 d√≠as
            </h3>
            <div id="chart-container" class="h-64">
                <canvas id="revenue-chart"></canvas>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card p-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4">
                Actividad Reciente
            </h3>
            <div class="space-y-4">
                {
                    recentBookings.length === 0 ? (
                        <p class="text-slate-500 text-center py-8">
                            No hay reservas recientes
                        </p>
                    ) : (
                        recentBookings.map((booking) => (
                            <div class="flex items-center gap-3 p-3 rounded-lg bg-slate-50">
                                <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center font-bold text-primary-600">
                                    {booking.customer.name.charAt(0)}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-slate-900 truncate">
                                        {booking.customer.name}
                                    </p>
                                    <p class="text-sm text-slate-500">
                                        {booking.service.name}
                                    </p>
                                </div>
                                <span class={statusColors[booking.status]}>
                                    {statusLabels[booking.status]}
                                </span>
                            </div>
                        ))
                    )
                }
            </div>
            <a href="/admin/bookings" class="btn btn-secondary w-full mt-4">
                Ver todas las reservas ‚Üí
            </a>
        </div>
    </div>

    <!-- Today's Schedule -->
    <div class="card p-6 mt-6">
        <h3 class="text-lg font-bold text-slate-900 mb-4">Agenda de Hoy</h3>
        {
            todayBookings.length === 0 ? (
                <p class="text-slate-500 text-center py-8">
                    No hay reservas para hoy
                </p>
            ) : (
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    {todayBookings
                        .sort((a, b) => a.time.localeCompare(b.time))
                        .map((booking) => (
                            <div class="p-4 rounded-xl border border-slate-200 hover:border-primary-300 transition-colors">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xl font-bold text-primary-600">
                                        {booking.time}
                                    </span>
                                    <span class={statusColors[booking.status]}>
                                        {statusLabels[booking.status]}
                                    </span>
                                </div>
                                <p class="font-medium text-slate-900">
                                    {booking.service.name}
                                </p>
                                <p class="text-sm text-slate-500">
                                    {new Intl.NumberFormat("es-PY").format(
                                        Number(booking.totalPrice),
                                    )}{" "}
                                    ‚Ç≤
                                </p>
                            </div>
                        ))}
                </div>
            )
        }
    </div>

    <script define:vars={{ chartData }}>
        import("chart.js").then((Chart) => {
            Chart.Chart.register(
                Chart.CategoryScale,
                Chart.LinearScale,
                Chart.BarElement,
                Chart.Title,
                Chart.Tooltip,
                Chart.Legend,
            );

            const ctx = document.getElementById("revenue-chart");
            if (ctx) {
                new Chart.Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: chartData.map((d) => d.date),
                        datasets: [
                            {
                                label: "Ingresos",
                                data: chartData.map((d) => d.amount),
                                backgroundColor: "rgba(59, 130, 246, 0.5)",
                                borderColor: "rgb(59, 130, 246)",
                                borderWidth: 1,
                                borderRadius: 8,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) =>
                                        value.toLocaleString("es-PY") + " ‚Ç≤",
                                },
                            },
                        },
                    },
                });
            }
        });
    </script>
</AdminLayout>
