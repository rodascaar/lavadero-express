---
import AdminLayout from "../../layouts/AdminLayout.astro";
import prisma from "../../lib/prisma";

// Fetch bookings with pagination
const bookings = await prisma.booking.findMany({
    include: {
        customer: true,
        vehicle: true,
        service: true,
    },
    orderBy: [{ date: "desc" }, { time: "asc" }],
    take: 100,
});

const statusColors: Record<string, string> = {
    PENDING: "badge-pending",
    CONFIRMED: "badge-confirmed",
    IN_PROGRESS: "badge-in-progress",
    COMPLETED: "badge-completed",
    CANCELLED: "badge-cancelled",
};

const statusLabels: Record<string, string> = {
    PENDING: "Pendiente",
    CONFIRMED: "Confirmado",
    IN_PROGRESS: "En Proceso",
    COMPLETED: "Finalizado",
    CANCELLED: "Cancelado",
};

const paymentLabels: Record<string, string> = {
    CASH: "Efectivo",
    TRANSFER: "Transferencia",
    QR: "QR",
    PAYMENT_LINK: "Link de Pago",
};
---

<AdminLayout title="Reservas">
    <!-- Filters -->
    <div class="card p-4 mb-6">
        <div class="flex flex-wrap items-center gap-4">
            <div>
                <label class="label">Estado</label>
                <select id="filter-status" class="input py-2">
                    <option value="">Todos</option>
                    <option value="PENDING">Pendiente</option>
                    <option value="CONFIRMED">Confirmado</option>
                    <option value="IN_PROGRESS">En Proceso</option>
                    <option value="COMPLETED">Finalizado</option>
                    <option value="CANCELLED">Cancelado</option>
                </select>
            </div>
            <div>
                <label class="label">Fecha</label>
                <input type="date" id="filter-date" class="input py-2" />
            </div>
            <div class="flex-1"></div>
            <button id="btn-refresh" class="btn btn-secondary">
                üîÑ Actualizar
            </button>
        </div>
    </div>

    <!-- Bookings Table -->
    <div class="card">
        <div class="table-container">
            <table class="table" id="bookings-table">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Fecha/Hora</th>
                        <th>Cliente</th>
                        <th>Veh√≠culo</th>
                        <th>Servicio</th>
                        <th>Total</th>
                        <th>Pago</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {
                        bookings.length === 0 ? (
                            <tr>
                                <td
                                    colspan="9"
                                    class="text-center py-8 text-gray-400"
                                >
                                    No hay reservas registradas
                                </td>
                            </tr>
                        ) : (
                            bookings.map((booking) => (
                                <tr
                                    data-id={booking.id}
                                    data-status={booking.status}
                                >
                                    <td>
                                        <span class="font-mono text-sm font-medium text-primary-400">
                                            {booking.referenceCode}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="font-medium">
                                            {new Date(
                                                booking.date,
                                            ).toLocaleDateString("es-ES", {
                                                weekday: "short",
                                                day: "numeric",
                                                month: "short",
                                            })}
                                        </div>
                                        <div class="text-gray-400 text-sm">
                                            {booking.time}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="font-medium">
                                            {booking.customer.name}
                                        </div>
                                        <div class="text-gray-400 text-sm">
                                            {booking.customer.phone}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="font-medium">
                                            {booking.vehicle?.plate || "-"}
                                        </div>
                                        {booking.vehicle?.model && (
                                            <div class="text-gray-400 text-sm">
                                                {booking.vehicle.model}
                                            </div>
                                        )}
                                    </td>
                                    <td>{booking.service.name}</td>
                                    <td class="font-medium">
                                        {new Intl.NumberFormat("es-PY").format(
                                            Number(booking.totalPrice),
                                        )}{" "}
                                        ‚Ç≤
                                    </td>
                                    <td>
                                        {paymentLabels[booking.paymentMethod]}
                                    </td>
                                    <td>
                                        <select
                                            class="status-select input py-1 px-2 text-sm min-w-[130px]"
                                            data-id={booking.id}
                                            data-current={booking.status}
                                        >
                                            {Object.entries(statusLabels).map(
                                                ([value, label]) => (
                                                    <option
                                                        value={value}
                                                        selected={
                                                            booking.status ===
                                                            value
                                                        }
                                                    >
                                                        {label}
                                                    </option>
                                                ),
                                            )}
                                        </select>
                                    </td>
                                    <td>
                                        <div class="flex gap-2">
                                            {booking.status === "PENDING" && (
                                                <button
                                                    class="btn-rescue btn btn-sm bg-primary-600/20 text-primary-400 hover:bg-primary-600 hover:text-white"
                                                    data-id={booking.id}
                                                    data-phone={
                                                        booking.customer.phone
                                                    }
                                                    data-name={
                                                        booking.customer.name
                                                    }
                                                    data-code={
                                                        booking.referenceCode
                                                    }
                                                    data-time={booking.time}
                                                    data-date={new Date(
                                                        booking.date,
                                                    ).toLocaleDateString(
                                                        "es-ES",
                                                    )}
                                                    data-plate={
                                                        booking.vehicle?.plate
                                                    }
                                                    data-model={
                                                        booking.vehicle?.model
                                                    }
                                                    data-service={
                                                        booking.service.name
                                                    }
                                                    data-price={Number(
                                                        booking.totalPrice,
                                                    )}
                                                    title="Rescatar Reserva (WhatsApp)"
                                                >
                                                    üí¨ Rescatar
                                                </button>
                                            )}
                                            <button
                                                class="btn-copy-ticket btn btn-sm border border-white/10 text-gray-400 hover:text-white"
                                                data-id={booking.id}
                                                data-payload={JSON.stringify({
                                                    referenceCode:
                                                        booking.referenceCode,
                                                    customerName:
                                                        booking.customer.name,
                                                    customerPhone:
                                                        booking.customer.phone,
                                                    plate: booking.vehicle
                                                        ?.plate,
                                                    vehicleModel:
                                                        booking.vehicle?.model,
                                                    serviceName:
                                                        booking.service.name,
                                                    date: new Date(
                                                        booking.date,
                                                    ).toLocaleDateString(
                                                        "es-ES",
                                                    ),
                                                    time: booking.time,
                                                    totalPrice: Number(
                                                        booking.totalPrice,
                                                    ),
                                                    paymentMethod:
                                                        booking.paymentMethod,
                                                })}
                                                title="Copiar Ticket"
                                            >
                                                üìã
                                            </button>
                                            <button
                                                class="btn-delete btn btn-sm text-red-500 hover:bg-red-500/10"
                                                data-id={booking.id}
                                                title="Eliminar"
                                            >
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )
                    }
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Status change handler
        document.querySelectorAll(".status-select").forEach((select) => {
            select.addEventListener("change", async (e) => {
                const target = e.target as HTMLSelectElement;
                const id = target.dataset.id;
                const newStatus = target.value;
                const currentStatus = target.dataset.current;

                try {
                    const response = await fetch(`/api/bookings/${id}`, {
                        method: "PATCH",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ status: newStatus }),
                    });

                    if (response.ok) {
                        target.dataset.current = newStatus;
                        // Update row styling based on status
                        const row = target.closest("tr");
                        if (row) {
                            row.dataset.status = newStatus;
                        }
                        // Show success feedback
                        target.classList.add("ring-2", "ring-emerald-500");
                        setTimeout(
                            () =>
                                target.classList.remove(
                                    "ring-2",
                                    "ring-emerald-500",
                                ),
                            1000,
                        );
                    } else {
                        target.value = currentStatus || "";
                        alert("Error al actualizar el estado");
                    }
                } catch (error) {
                    target.value = currentStatus || "";
                    alert("Error de conexi√≥n");
                }
            });
        });

        // Delete handler
        document.querySelectorAll(".btn-delete").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                const target = e.currentTarget as HTMLButtonElement;
                const id = target.dataset.id;

                if (!confirm("¬øEst√°s seguro de eliminar esta reserva?")) return;

                try {
                    const response = await fetch(`/api/bookings/${id}`, {
                        method: "DELETE",
                    });

                    if (response.ok) {
                        const row = target.closest("tr");
                        row?.remove();
                    } else {
                        alert("Error al eliminar");
                    }
                } catch (error) {
                    alert("Error de conexi√≥n");
                }
            });
        });

        // Rescue handler (WhatsApp Proactive)
        document.querySelectorAll(".btn-rescue").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const target = e.currentTarget as HTMLButtonElement;
                const name = target.dataset.name;
                const phone = target.dataset.phone!.replace(/\D/g, "");
                const time = target.dataset.time;

                // Get business name from settings if possible, or use default
                const businessName = "AutoSpa Premium";
                const message = `Hola ${name}, soy de ${businessName}. Vemos que generaste una reserva para hoy a las ${time}. Confirmamos que tu lugar est√° asegurado. ¬øPodr√≠as confirmar si llegas a tiempo?`;

                const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                window.open(url, "_blank");
            });
        });

        // Copy Ticket handler
        document.querySelectorAll(".btn-copy-ticket").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const target = e.currentTarget as HTMLButtonElement;
                const data = JSON.parse(target.dataset.payload!);

                const formattedPrice = new Intl.NumberFormat("es-PY").format(
                    data.totalPrice,
                );
                const ticket = `AUTO SPA PREMIUM - TICKET DE RESERVA
C√ìDIGO : ${data.referenceCode}
CLIENTE: ${data.customerName}
VEH√çCULO: ${data.plate}${data.vehicleModel ? ` - ${data.vehicleModel}` : ""}
FECHA: ${data.date}
HORA: ${data.time}
SERVICIO: ${data.serviceName}
PAGO: ${data.paymentMethod}
TOTAL: ${formattedPrice} Gs.
Gracias por su preferencia.`;

                navigator.clipboard.writeText(ticket);

                // Visual feedback
                const originalText = target.innerText;
                target.innerText = "‚úÖ";
                setTimeout(() => (target.innerText = "üìã"), 2000);
            });
        });

        // Refresh button
        document
            .getElementById("btn-refresh")
            ?.addEventListener("click", () => {
                window.location.reload();
            });

        // Filter by status
        document
            .getElementById("filter-status")
            ?.addEventListener("change", (e) => {
                const status = (e.target as HTMLSelectElement).value;
                document
                    .querySelectorAll("#bookings-table tbody tr")
                    .forEach((row) => {
                        const rowStatus = (row as HTMLElement).dataset.status;
                        (row as HTMLElement).style.display =
                            !status || rowStatus === status ? "" : "none";
                    });
            });
    </script>
</AdminLayout>
