---
import AdminLayout from '../../layouts/AdminLayout.astro';
import prisma from '../../lib/prisma';

// Fetch customers with at least one completed booking
const customers = await prisma.customer.findMany({
  include: {
    bookings: {
      include: {
        service: true,
      },
      orderBy: { date: 'desc' },
    },
  },
  orderBy: { createdAt: 'desc' },
});

// Calculate stats for each customer
const customersWithStats = customers.map((customer) => {
  const completedBookings = customer.bookings.filter((b) => b.status === 'COMPLETED');
  const totalSpent = completedBookings.reduce((sum, b) => sum + Number(b.totalPrice), 0);
  const lastVisit = completedBookings[0]?.date || null;
  const totalVisits = completedBookings.length;

  return {
    ...customer,
    totalSpent,
    lastVisit,
    totalVisits,
    isLoyal: totalVisits >= 3,
  };
}).filter(c => c.totalVisits > 0).sort((a, b) => b.totalVisits - a.totalVisits);
---

<AdminLayout title="Clientes (CRM)">
  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="kpi-card">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-primary-100 flex items-center justify-center text-2xl">
          üë•
        </div>
        <div>
          <div class="kpi-value">{customersWithStats.length}</div>
          <div class="kpi-label">Clientes Activos</div>
        </div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-amber-100 flex items-center justify-center text-2xl">
          ‚≠ê
        </div>
        <div>
          <div class="kpi-value">{customersWithStats.filter(c => c.isLoyal).length}</div>
          <div class="kpi-label">Clientes Frecuentes (3+ visitas)</div>
        </div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center text-2xl">
          üí∞
        </div>
        <div>
          <div class="kpi-value">
            {new Intl.NumberFormat('es-PY', { notation: 'compact' }).format(
              customersWithStats.reduce((sum, c) => sum + c.totalSpent, 0)
            )} ‚Ç≤
          </div>
          <div class="kpi-label">Total Ingresos</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search -->
  <div class="card p-4 mb-6">
    <input
      type="search"
      id="search"
      class="input"
      placeholder="Buscar por nombre, placa o tel√©fono..."
    />
  </div>

  <!-- Customers List -->
  <div class="space-y-4" id="customers-list">
    {customersWithStats.length === 0 ? (
      <div class="card p-8 text-center text-slate-500">
        <span class="text-4xl block mb-4">üë•</span>
        No hay clientes con servicios completados todav√≠a
      </div>
    ) : (
      customersWithStats.map((customer) => (
        <div 
          class="card p-6 customer-card"
          data-name={customer.name.toLowerCase()}
          data-plate={customer.plate.toLowerCase()}
          data-phone={customer.phone}
        >
          <div class="flex flex-col md:flex-row md:items-center gap-4">
            <!-- Avatar & Info -->
            <div class="flex items-center gap-4 flex-1">
              <div class={`w-14 h-14 rounded-full flex items-center justify-center text-xl font-bold text-white ${customer.isLoyal ? 'bg-amber-500' : 'bg-primary-500'}`}>
                {customer.name.charAt(0)}
                {customer.isLoyal && <span class="absolute -top-1 -right-1 text-base">‚≠ê</span>}
              </div>
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="font-bold text-lg text-slate-900">{customer.name}</h3>
                  {customer.isLoyal && <span class="badge bg-amber-100 text-amber-700">Frecuente</span>}
                </div>
                <div class="flex flex-wrap items-center gap-4 text-sm text-slate-600 mt-1">
                  <span>üì± {customer.phone}</span>
                  <span>üöó {customer.plate}</span>
                  {customer.model && <span>‚Ä¢ {customer.model}</span>}
                </div>
              </div>
            </div>

            <!-- Stats -->
            <div class="flex items-center gap-6 text-center">
              <div>
                <div class="text-2xl font-bold text-primary-600">{customer.totalVisits}</div>
                <div class="text-xs text-slate-500">Visitas</div>
              </div>
              <div>
                <div class="text-2xl font-bold text-emerald-600">
                  {new Intl.NumberFormat('es-PY', { notation: 'compact' }).format(customer.totalSpent)} ‚Ç≤
                </div>
                <div class="text-xs text-slate-500">Total Gastado</div>
              </div>
              <div>
                <div class="text-sm font-medium text-slate-700">
                  {customer.lastVisit ? new Date(customer.lastVisit).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }) : '-'}
                </div>
                <div class="text-xs text-slate-500">√öltima Visita</div>
              </div>
            </div>
          </div>

          <!-- Booking History -->
          {customer.bookings.filter(b => b.status === 'COMPLETED').length > 0 && (
            <details class="mt-4">
              <summary class="cursor-pointer text-sm text-primary-600 hover:text-primary-700">
                Ver historial ({customer.bookings.filter(b => b.status === 'COMPLETED').length} servicios)
              </summary>
              <div class="mt-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                {customer.bookings.filter(b => b.status === 'COMPLETED').slice(0, 6).map((booking) => (
                  <div class="p-3 rounded-lg bg-slate-50 text-sm">
                    <div class="font-medium">{booking.service.name}</div>
                    <div class="text-slate-500">
                      {new Date(booking.date).toLocaleDateString('es-ES')} ‚Ä¢ {new Intl.NumberFormat('es-PY').format(Number(booking.totalPrice))} ‚Ç≤
                    </div>
                  </div>
                ))}
              </div>
            </details>
          )}
        </div>
      ))
    )}
  </div>

  <script>
    const searchInput = document.getElementById('search') as HTMLInputElement;
    const customerCards = document.querySelectorAll('.customer-card');

    searchInput?.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase();
      
      customerCards.forEach((card) => {
        const name = (card as HTMLElement).dataset.name || '';
        const plate = (card as HTMLElement).dataset.plate || '';
        const phone = (card as HTMLElement).dataset.phone || '';
        
        const matches = name.includes(query) || plate.includes(query) || phone.includes(query);
        (card as HTMLElement).style.display = matches ? '' : 'none';
      });
    });
  </script>
</AdminLayout>
